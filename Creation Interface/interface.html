<!doctype html>
<html>
<head>
    <script src='https://d3js.org/d3.v5.min.js'></script>
    <script src='https://fastcdn.org/FileSaver.js/1.1.20151003/FileSaver.js'></script>
</head>

<body>
    <style>

        * { box-sizing: border-box; }
        body {
              font: 16px Arial;
        }
        .autocomplete.multiBox {
              /*the container must be positioned relative:*/
              /*margin: 0 auto; */
              position: relative;
              display: inline-block;
        }
        .autocomplete.singleBox {
            margin: 0 auto;
        }
        form {
            text-align: center;
            width: 75%;
            margin: auto;
        }
        input {
              border: 1px solid transparent;
              background-color: #f1f1f1;
              padding: 10px;
              font-size: 16px;
              transition: 0.3s;
              box-shadow: 2px 3px 2px #888;
              border-radius: 3px;
        }
        input[type=text] {
              background-color: #f1f1f1;
        }
        input[type=submit] {
              background-color: DodgerBlue;
              color: #fff;
        }
        input:hover {
            background-color: #f2f2f2;
        }
        input:hover[type=submit]{
            background-color: #1EAFFF;
        }
        input.copypaste:hover{
            background-color: #f2f2f2;
        }
        input.reset:hover{
            background-color: #000;
            color: #fff;
        }
        button {
                background-color: DodgerBlue;
                color: #fff;
        }

        input.reset {
                background-color: Red;
                color: #fff;
        }

        input.copypaste {
                background-color: #ccc;
                color: #000;
        }

        .autocomplete-items {
              position: relative;
              border: 1px solid #d4d4d4;
              border-bottom: none;
              border-top: none;
              z-index: 99;
              /*position the autocomplete items to be the same width as the container:*/
              top: 100%;
              left: 0;
              right: 0;
        }
        .autocomplete-items div {
              padding: 10px;
              cursor: pointer;
              background-color: #fff;
              border-bottom: 1px solid #d4d4d4;
        }
        .autocomplete-items div:hover {
              /*when hovering an item:*/
              background-color: #e9e9e9;
        }
        .autocomplete-active {
              /*when navigating through the items using the arrow keys:*/
              background-color: DodgerBlue !important;
              color: #ffffff;
        }


        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
        }

        /* Style the buttons that are used to open the tab content */
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
        }

        /* Change background color of buttons on hover */
        .tab button:hover {
            background-color: #ddd;
        }

        /* Create an active/current tablink class */
        .tab button.active {
            background-color: #ccc;
        }

        /* Style the tab content */
        .tabcontent {
            display: none;
            /* padding: 6px 12px; */
            border: 1px solid #ccc;
            border-top: none;
        }

        .tablinks {
            color: black;
            width: 50%;
        }

        li span {
            font-family: courier;
        }

        li input {
            font-family: courier;
        }



    </style>
    <script>

    /*

    Interface t05 (prev t04) is version 2.0 of the interface.

    The goal of this is to allow the user to essentially program the robots using pseudocode.
    The commands are attempted to autocomplete as the user types, so that there is no confusion
    as to what the list of commands is or what they can be.
    There are convenient copy/paste options because most of the time, the robots will be following similar
    algorithms, with only a slight change in values passed to them. The propsed design choice is to
    show default commands with an X in place of a value, and set that value to be
    random (when based on angles) or indefinitely/until a signal is recieved (when based on time).
    For now, input via the main textbox, paste button, and editing a line is permitted.
    Input via a file was added in version t04.
    Support for an exit protocol was added in version t05.


    TODO: fix loading multiple different files in one run.
    TODO: delete and insert specific lines in the command list.
    TODO: fix logic on EDIT to include +step support
    TODO: fix window.numbots to be null on import file


    Changed: t04 --> t05
    - ! Added a second tab to a multi-box command block, allowing user to specify
      a set of commands to execute upon finding the exit. (Exit Protocol)
    - Fixed a bug which caused the exit protocol to be copied over all robots with a deep copy.
    - Added support for loading and saving a file with exit commands and regular commands for separate assignment.
    - Added support for an exit protocol when adding commands to all at once.
    - Added save button to single-box command interface.
    - Make buttons like enter, x, and tabs focus on the input


    */

    var winH = window.innerHeight;
    var winW = window.innerWidth;
    var unit2px = ((winH < winW) ? (winH) : (winW))/8; //one unit is 1/8th of the smaller portion screen
    var eventListener;
    var numBots;
    var communication;
    var commands = [];
    var full;
    const commandsList = ['GoOutAtAngle <angle>', 'Wait [time]', 'FollowWall <left | right> [angle]',
                          'GoToPoint <x, y>', 'WaitAverage', 'GoToWallAtAngle <angle>', 'GoToExit', 'Intercept'];

    const comparator = ['GoOutAtAngle','Wait','FollowWall','GoToCenter', 'GoToPoint;',
                        'GoToWallAtAngle','WaitAverage','GoToExit', 'Intercept'];

    var copy = [];



    var titleArea = d3.select('body').append('svg')
        .attr('width', winW)
        .attr('height', unit2px)
        .attr('class', 'title');
    var title = titleArea.append('text')
        .text('Evacuation Room')
        .attr('text-anchor', 'middle')
        .attr('x', winW/2)
        .attr('y', unit2px/2)
        .attr('font-size', '48px')
        .attr('class', 'title');
    d3.select('body').append('p')
        .style('text-align', 'center')
        .text('Replace "X" in a command suggestion with a number to specify a value! Use \'+value\' to specify a step amount when assigning to all robots at once.');






    function updateList(){
        copy = [];
        var tabName = 'commandProtocol';
        var numBots = window.numBots;
        if (numBots == null){
            var numBots = document.getElementById('numBotsMulti').value;
            commands = [];
        }
        if (numBots > 100) {
            alert("Slow down there partner, don't wanna crash the site... Try a number in range.")
            return;
        }
        if (numBots < 1) {
            alert("You need at least 1 robot!");
            return;
        }
        d3.selectAll('.autocomplete').remove();

        for (i=0; i<numBots;i++) {
            var full = window.full;
            if (!full){
                commands.push([]);
                commands[i].push([]);
                full = false;
            }
            else {
                full = true;
            }
            var d = d3.select('body').append('div')
                .style('width', unit2px*3+'px')
                .style('height', unit2px*3+'px')
                .attr('float', 'left')
                .style('position', 'relative')
                .style('overflow-y', 'scroll')
                .attr('class', 'autocomplete multiBox')
                .attr('id', 'divno'+i)
                .style('border', '1px black solid')
                .style('border-radius', '5px')
                .style('margin', '0.5%');


            var nav = d.append('div')
                .attr('class', 'tab');
            nav.append('button')
                .attr('class', 'tablinks')
                .classed('active', 'true')
                .style('width', '50%')
                .text('Commands')
                .on('click', function() {
                    var id = +d3.select(this.parentNode.parentNode).attr('id').substring(5);
                    d3.select('#divno'+id).select('p').text('Bot ID No. '+id+': Command Protocol');
                    d3.select(this.parentNode).selectAll('.tablinks.active').attr('class', 'tablinks');
                    d3.select(this.parentNode.parentNode).selectAll('.exitProtocol').style('display', 'none');
                    d3.select(this.parentNode.parentNode).selectAll('.commandProtocol').style('display', 'inline-block');
                    d3.select(this).classed('active', 'true');
                    tabName = 'commandProtocol';
                    d3.select(this.parentNode.parentNode).select('.textArea').node().focus();
                });
            nav.append('button')
                .attr('class', 'tablinks')
                .style('width', '50%')
                .text('Exit Protocol')
                .on('click', function() {
                    var id = +d3.select(this.parentNode.parentNode).attr('id').substring(5);
                    d3.select('#divno'+id).select('p').text('Bot ID No. '+id+': Exit Protocol');
                    d3.select(this.parentNode).selectAll('.tablinks.active').attr('class', 'tablinks');
                    d3.select(this.parentNode.parentNode).selectAll('.commandProtocol').style('display', 'none')
                    d3.select(this.parentNode.parentNode).selectAll('.exitProtocol').style('display', 'inline-block');
                    d3.select(this).classed('active', 'true');
                    tabName = 'exitProtocol';
                    d3.select(this.parentNode.parentNode).select('.textArea').node().focus();
                });

            var form = d.append('form')
                .attr('id', 'formno'+i)
                .attr('action', 'javascript:void(0)')
                .attr('autocomplete', 'off')
                .style('margin', '10%')
                .style('text-align', 'center');
            d.append('p').text('Bot ID No. '+i + ": Command Protocol").style('text-align', 'center');
            var list = d.append('ol').attr('class', 'commandProtocol');
            var exitProtoList = d.append('ol').style('display', 'none').attr('class', 'exitProtocol');
            var b = form.append('input')
                .attr('type', 'text')
                .attr('id', 'inputno'+i) // !important!, how we differentiate between different form inputs.
                .style('display', 'inline')
                .attr('class', 'textArea');

            form.append('input')//ENTER BUTTON
                .attr('type', 'submit')
                .property('value','Enter')
                .on('click', function() {
                    tabName = (d3.select(this.parentNode.parentNode).select('.tab').select('.tablinks.active').text()) == 'Commands' ? 'commandProtocol' : 'exitProtocol';
                    var id = d3.select(this.parentNode).attr('id').substring(6);
                    var v = d3.select(this.parentNode).select('input').property('value');
                    if (v == '') {
                        v = '__________';
                    }
                    d3.select(this.parentNode).select('input').property('value',''); //reset textbox because why not.
                    if (tabName == 'exitProtocol') {
                        commands[id][0].push(v);
                    }
                    else{
                        commands[id].push(v);
                    }
                    var idno = d3.select(this.parentNode.parentNode).select('.'+tabName).node().getElementsByTagName('li').length;
                    var li = d3.select(this.parentNode.parentNode).select('.'+tabName).append('li').attr('id', 'listid'+idno);
                    li.append('span')
                        .text(v)
                        .attr('class', 'display')
                        .on('click' , function(d) {
                            var edit = d3.select(this).text();
                            d3.select(this).style('display', 'none');
                            d3.select(this.parentNode).select('.edit').style('display', 'inline-block').property('value', edit);
                        });
                    li.append('input')
                        .attr('class', 'edit')
                        .style('display', 'none')
                        .on('focusout', function(){
                            var idindex = +d3.select(this.parentNode).attr('id').substring(6);
                            var edit = d3.select(this).property('value');
                            if (edit == ''){
                                edit = '__________';
                            }
                            d3.select(this).style('display', 'none');
                            d3.select(this.parentNode).select('.display').style('display', 'inline-block').text(edit);
                            if (tabName == 'exitProtocol'){
                                commands[id][0][idindex] = edit;
                            }
                            else{
                                commands[id][idindex+1] = edit;
                            }
                        });
                    d3.select(this.parentNode).select('.textArea').node().focus();
                });

            if (full){
                for (j=0;j<commands[i].length;j++){
                    if (j == 0) {
                        for (k=0;k<commands[i][0].length;k++){
                            var ol = d3.select('#divno'+i).select('.exitProtocol');
                            var idno = ol.node().getElementsByTagName('li').length;
                            var li = ol.append('li').attr('id', 'listid'+idno);
                            li.append('span')
                                .text(commands[i][0][k])
                                .attr('class', 'display')
                                .on('click' , function(d) {
                                    var edit = d3.select(this).text();
                                    d3.select(this).style('display', 'none');
                                    d3.select(this.parentNode).select('.edit').style('display', 'inline').property('value', edit);
                                });
                            li.append('input')
                                .attr('class', 'edit')
                                .style('display', 'none')
                                .on('focusout', function(){
                                    var id = d3.select(this.parentNode.parentNode.parentNode).attr('id').substring(5);
                                    var idindex = +d3.select(this.parentNode).attr('id').substring(6);
                                    var edit = d3.select(this).property('value');
                                    if (edit == ''){
                                        edit = '__________';
                                    }
                                    d3.select(this).style('display', 'none');
                                    d3.select(this.parentNode).select('.display').style('display', 'inline').text(edit);
                                    if (tabName == 'exitProtocol'){
                                        commands[id][0][idindex] = edit;
                                    }
                                    else{
                                        commands[id][idindex+1] = edit;
                                    }
                                });
                        }
                    }
                    else{
                        //var id = d3.select(this.parentNode).attr('id').substring(6);
                        var ol = d3.select('#divno'+i).select('.commandProtocol');
                        var li = ol.append('li').attr('id', 'listid'+i);
                        li.append('span')
                            .text(commands[i][j])
                            .attr('class', 'display')
                            .on('click' , function(d) {
                                var edit = d3.select(this).text();
                                d3.select(this).style('display', 'none');
                                d3.select(this.parentNode).select('.edit').style('display', 'inline').property('value', edit);
                            });
                        li.append('input')
                            .attr('class', 'edit')
                            .style('display', 'none')
                            .on('focusout', function(){
                                var idindex = +d3.select(this.parentNode).attr('id').substring(6);
                                var id = +d3.select(this.parentNode.parentNode.parentNode).attr('id').substring(5);
                                var edit = d3.select(this).property('value');
                                if (edit == ''){
                                    edit = '__________';
                                }
                                d3.select(this).style('display', 'none');
                                d3.select(this.parentNode).select('.display').style('display', 'inline').text(edit);
                                commands[id][idindex] = edit;
                            });
                    }
                }
            }

            form.append('input')//X BUTTON
                .attr('type', 'submit')
                .property('value','X')
                .attr('class', 'reset')
                .on('click', function(){
                    var id = d3.select(this.parentNode).attr('id').substring(6);
                    commands[id] = [];
                    commands[id][0] = [];
                    var divTemp = d3.select(this.parentNode.parentNode);
                    divTemp.select('.commandProtocol').remove();
                    divTemp.select('.exitProtocol').remove();
                    var c = divTemp.append('ol').attr('class', 'commandProtocol');
                    var e = divTemp.append('ol').attr('class', 'exitProtocol');
                    if (tabName == 'commandProtocol'){
                        c.style('display', 'inline-block');
                    }
                    else{
                        e.style('display', 'inline-block');
                    }
                    d3.select(this.parentNode).select('.textArea').node().focus();
                });

            form.append('input') // COPY BUTTON
                .attr('type', 'submit')
                .attr('class', 'copypaste')
                .property('value', 'Copy')
                .on('click', function() {
                    var id = d3.select(this.parentNode).attr('id').substring(6);
                    copy = commands[id].slice(0);
                });

            form.append('input') //PASTE BUTTON
                .attr('type', 'submit')
                .attr('class', 'copypaste')
                .property('value', 'Paste')
                .on('click', function() {
                    var id = d3.select(this.parentNode).attr('id').substring(6);
                    divTemp = d3.select(this.parentNode.parentNode);
                    divTemp.select('.exitProtocol').remove();
                    divTemp.select('.commandProtocol').remove();
                    var c = divTemp.append('ol').attr('class', 'commandProtocol');
                    var e = divTemp.append('ol').attr('class', 'exitProtocol');
                    var tabTemp = divTemp.select('.tab').select('.tablinks.active');
                    if (tabTemp.text() == 'Commands'){
                        e.style('display', 'none');
                    }
                    else{
                        c.style('display', 'none');
                    }
                    for (j=0;j<copy.length;j++) {
                        var id = d3.select(this.parentNode.parentNode).attr('id').substring(5);
                        if (j == 0) {
                            for (k=0;k<copy[0].length;k++){
                                var ol = d3.select('#divno'+id).select('.exitProtocol');
                                var idno = ol.node().getElementsByTagName('li').length;
                                var li = ol.append('li').attr('id', 'listid'+idno);
                                li.append('span')
                                    .text(copy[0][k])
                                    .attr('class', 'display')
                                    .on('click' , function(d) {
                                        var edit = d3.select(this).text();
                                        d3.select(this).style('display', 'none');
                                        d3.select(this.parentNode).select('.edit').style('display', 'inline').property('value', edit);
                                    });
                                li.append('input')
                                    .attr('class', 'edit')
                                    .style('display', 'none')
                                    .on('focusout', function(){
                                        var idindex = +d3.select(this.parentNode).attr('id').substring(6);
                                        var edit = d3.select(this).property('value');
                                        if (edit == ''){
                                            edit = '__________';
                                        }
                                        d3.select(this).style('display', 'none');
                                        d3.select(this.parentNode).select('.display').style('display', 'inline').text(edit);
                                        if (tabName == 'exitProtocol'){
                                            commands[id][0][idindex] = edit;
                                        }
                                        else{
                                            commands[id][idindex+1] = edit;
                                        }
                                    });
                            }
                        }
                        else {
                            var li = divTemp.select('.commandProtocol').append('li').attr('id', 'listid'+j-1);
                            li.append('span')
                                .text(copy[j])
                                .attr('class', 'display')
                                .on('click' , function(d) {
                                    var edit = d3.select(this).text();
                                    d3.select(this).style('display', 'none');
                                    d3.select(this.parentNode).select('.edit').style('display', 'inline').property('value', edit);
                                })
                            li.append('input')
                                .attr('class', 'edit')
                                .style('display', 'none')
                                .on('focusout', function(){
                                    var idindex = +d3.select(this.parentNode).attr('id').substring(6)-1;
                                    var edit = d3.select(this).property('value');
                                    if (edit == ''){
                                        edit = '__________';
                                    }
                                    d3.select(this).style('display', 'none');
                                    d3.select(this.parentNode).select('.display').style('display', 'inline').text(edit);
                                    if (tabName == 'exitProtocol'){
                                        commands[id][0][idindex] = edit;
                                    }
                                    else{
                                        commands[id][idindex+1] = edit;
                                    }
                                });
                        }
                    }
                    commands[id] = [[]];
                    commands[id][0] = copy[0].slice(0);
                    for (i=1;i<copy.length;i++){
                        commands[id].push(copy[i]);
                    }

                });

            //add all event listeners to inputs
            autocomplete(b.node(), commandsList);

        }
        full = false;
    }

    function updateListSingle(){
        var tabName = 'commandProtocol';
        d3.selectAll('.autocomplete').remove();
        numBots = +d3.select('#numBotsSingle').property('value');
        if (numBots > 100) {
            alert("Slow down there partner, don't wanna crash the site... Try a number in range.")
            return;
        }
        if (numBots < 1) {
            alert("You need at least 1 robot!");
            return;
        }
        commands = [];
        for (i=0;i<numBots;i++){
            commands[i] = [];
            commands[i].push([]);
        }

        var recommendedArg = parseFloat(360/numBots).toFixed(2);
        var d = d3.select('body').append('div')
            .style('width', unit2px*6+'px')
            .style('height', unit2px*3+'px')
            //.attr('float', 'left')
            //.style('position', 'relative')
            .style('overflow-y', 'scroll')
            .attr('class', 'autocomplete')
            .style('border', '1px black solid')
            .style('margin', '0 auto');


        var nav = d.append('div')
            .attr('class', 'tab');
        nav.append('button')
            .attr('class', 'tablinks')
            .classed('active', 'true')
            .text('Commands')
            .on('click', function(){
                d3.select(this.parentNode).selectAll('.tablinks.active').attr('class', 'tablinks');
                d3.select(this.parentNode.parentNode).selectAll('.exitProtocol').style('display', 'none');
                d3.select(this.parentNode.parentNode).selectAll('.commandProtocol').style('display', 'inline-block');
                d3.select(this).classed('active', 'true');
                tabName = 'commandProtocol';
                d3.select(this.parentNode.parentNode).select('.textArea').node().focus();
            });
        nav.append('button')
            .attr('class', 'tablinks')
            .text('Exit Protocol')
            .on('click', function(){
                d3.select(this.parentNode).selectAll('.tablinks.active').attr('class', 'tablinks');
                d3.select(this.parentNode.parentNode).selectAll('.commandProtocol').style('display', 'none')
                d3.select(this.parentNode.parentNode).selectAll('.exitProtocol').style('display', 'inline-block');
                d3.select(this).classed('active', 'true');
                tabName = 'exitProtocol';
                d3.select(this.parentNode.parentNode).select('.textArea').node().focus();
            });


        d.append('p')
            .attr('float', 'right')
            .text('Recommended Step for GoOutAtAngle: +'+recommendedArg);

        var form = d.append('form')
            .attr('autocomplete', 'off')
            .attr('action', 'javascript:void(0)');

        var textArea = form.append('input')
            .attr('type', 'text')
            .attr('class', 'textArea');

        var list = d.append('ol').attr('class', 'commandProtocol');
        var exitProtoList = d.append('ol').attr('class', 'exitProtocol').style('display', 'none');

        autocomplete(textArea.node(), commandsList);

        form.append('input') // Enter Button
            .attr('type', 'submit')
            .property('value', 'Enter')
            .on('click', function(){
                tabName = (d3.select(this.parentNode.parentNode).select('.tab').select('.tablinks.active').text()) == 'Commands' ? 'commandProtocol' : 'exitProtocol';
                var step = null;
                var v = d3.select(this.parentNode).select('input').property('value');
                if (v == '') {
                    v = '__________';
                }
                else if (v.split(' ').length > 1 && v.split(' ')[1] != '' && v.split(' ')[1].includes('+')){
                    step = parseInt(v.split(' ')[1].substring(1));
                }
                d3.select(this.parentNode).select('input').property('value',''); //reset textbox because why not.
                if (tabName == 'exitProtocol'){
                    var copyV = v.slice(0);
                    for (i=0;i<commands.length;i++){
                        if (step != null){
                            var stepped = (i+1) * step;
                            if (v.split(' ')[0] == 'GoOutAtAngle'){
                                stepped = stepped % 360;
                            }
                            var index = v.indexOf('+');
                            copyV = v.substring(0, index) + stepped;
                        }
                        commands[i][0].push(copyV);
                    }

                }
                else {
                    var copyV = v.slice(0);
                    for (i=0;i<commands.length;i++){
                        if (step != null){
                            var stepped = (i+1) * step;
                            if (v.split(' ')[0] == "GoOutAtAngle"){
                                stepped = stepped % 360;
                            }
                            var index = v.indexOf('+');
                            copyV = v.substring(0, index) + stepped;
                        }

                        commands[i].push(copyV);
                    }
                }

                var idno = d3.select(this.parentNode.parentNode).select('.'+tabName).node().getElementsByTagName('li').length;
                var li = d3.select(this.parentNode.parentNode).select('.'+tabName).append('li').attr('id', 'listid'+idno);
                li.append('span')
                    .text(v)
                    .attr('class', 'display')
                    .on('click' , function(d) {
                        var edit = d3.select(this).text();
                        d3.select(this).style('display', 'none');
                        d3.select(this.parentNode).select('.edit').style('display', 'inline').property('value', edit);
                    });
                li.append('input')
                    .attr('class', 'edit')
                    .style('display', 'none')
                    .on('focusout', function(){
                        var idindex = +d3.select(this.parentNode).attr('id').substring(6);
                        var edit = d3.select(this).property('value');
                        if (edit == ''){
                            edit = '__________';
                        }
                        d3.select(this).style('display', 'none');
                        d3.select(this.parentNode).select('.display').style('display', 'inline').text(edit);
                        for (j=0;j<commands.length;j++){
                            if (tabName == 'commandProtocol'){
                                commands[j][idindex+1] = edit;
                            }
                            else {
                                commands[j][0][idindex] = edit;
                            }
                        }
                    });
                d3.select(this.parentNode).select('.textArea').node().focus();
            });

        form.append('input') // X Button
            .attr('type', 'submit')
            .property('value', 'X')
            .attr('class', 'reset')
            .on('click', function(){
                for (i=0;i<commands.length;i++){
                    commands[i] = [];
                    commands[i][0] = [];
                    var divTemp = d3.select(this.parentNode.parentNode);
                    divTemp.select('.commandProtocol').remove();
                    divTemp.select('.exitProtocol').remove();
                    var c = divTemp.append('ol').attr('class', 'commandProtocol').style('display', 'none');
                    var e = divTemp.append('ol').attr('class', 'exitProtocol').style('display', 'none');
                    if (tabName == 'commandProtocol'){
                        c.style('display', 'inline-block');
                    }
                    else{
                        e.style('display', 'inline-block');
                    }
                }
                d3.select(this.parentNode).select('.textArea').node().focus();
            });

    }

    function autocomplete(inp, arr) {
      // https://www.w3schools.com/howto/howto_js_autocomplete.asp //
      var currentFocus;
      inp.addEventListener("input", function(e) {
          var a, b, i, val = this.value;
          closeAllLists();
          if (!val) { return false; }
          currentFocus = -1;
          a = document.createElement("DIV");
          a.setAttribute("id", this.id + "autocomplete-list");
          a.setAttribute("class", "autocomplete-items");
          this.parentNode.appendChild(a);
          for (i = 0; i < arr.length; i++) {
            if (arr[i].substr(0, val.length).toUpperCase() == val.toUpperCase()) {
              b = document.createElement("DIV");
              b.innerHTML = "<strong>" + arr[i].substr(0, val.length) + "</strong>";
              b.innerHTML += arr[i].substr(val.length);
              b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
                  b.addEventListener("click", function(e) {
                  inp.value = this.getElementsByTagName("input")[0].value;
                  closeAllLists();
              });
              a.appendChild(b);
            }
          }
      });
      inp.addEventListener("keydown", function(e) {
          var x = document.getElementById(this.id + "autocomplete-list");
          if (x) x = x.getElementsByTagName("div");
          if (e.keyCode == 40) {
            currentFocus++;
            addActive(x);
          } else if (e.keyCode == 38) { //up
            currentFocus--;
            addActive(x);
          } else if (e.keyCode == 13) {
            e.preventDefault();
            if (currentFocus > -1) {
              if (x) x[currentFocus].click();
            }
          }
      });
      function addActive(x) {
        if (!x) return false;
        removeActive(x);
        if (currentFocus >= x.length) currentFocus = 0;
        if (currentFocus < 0) currentFocus = (x.length - 1);
        x[currentFocus].classList.add("autocomplete-active");
      }
      function removeActive(x) {
        for (var i = 0; i < x.length; i++) {
          x[i].classList.remove("autocomplete-active");
        }
      }
      function closeAllLists(elmnt) {
        var x = document.getElementsByClassName("autocomplete-items");
        for (var i = 0; i < x.length; i++) {
          if (elmnt != x[i] && elmnt != inp) {
          x[i].parentNode.removeChild(x[i]);
          }
        }
      }
      document.addEventListener("click", function (e) {
        closeAllLists(e.target);
      });
    }

    function saveCommands() {
        var l = commands.length;
        var s = '';

        console.log(commands);
        console.log(commands.length);

        for (i=0;i<l;i++){
            for (k=0;k<commands[i][0].length;k++){
                s+=commands[i][0][k] + '*';
            }
            s+='#';
            for (j=1;j<commands[i].length;j++){
                s+=commands[i][j] + '|';
            }
            s+='\n';
        }


        var blob = new Blob([s], {type: 'text/plain;charset=utf-8'});
        saveAs(blob, 'my-algorithm.icl');
    }

    function loadCommands(event) {
        var file = event.target.files[0]; //even though it only takes one file, the input type will still be a FileList.
        var fileName = document.getElementById('loadcommands').value;
        if (!fileName.includes('.icl')){
            alert('Please use a proper *.icl file to load your commands. If you think the file name is correct, then it might be corrupted.');
            return;
        }
        var fileReader = new FileReader();
        fileReader.onload = (function(file){
            var text = fileReader.result;
            var sText = text.split("\n");
            numBots = sText.length - 1;
            document.getElementById('numBotsMulti').value;
            commands = [];
            for (i=0;i<numBots;i++) {
                commands.push([]);
                commands[i].push([]);
                var exitProtocol = sText[i].split('#')[0];
                var commandProtocol = sText[i].split('#')[1];

                var exitComms = exitProtocol.split('*');
                var regularComms = commandProtocol.split('|');

                for (j=0;j<exitComms.length-1;j++){
                    commands[i][0].push(exitComms[j]);
                }
                for (k=0;k<regularComms.length-1;k++){
                    commands[i].push(regularComms[k]);
                }

            /*

                var outerCommand = sText[i].split('|');
                for (j=0;j<outerCommand.length-1;j++){
                    var innerCommand = outerCommand[j].split(":");
                    var comm = parseInt(innerCommand[0]);
                    for (c=comparator.length;c>=0;c--){
                        if (comm == c) {
                            comm = comparator[c];
                            break;
                        }
                    }
                    innerCommand[1] = innerCommand[1].replace(' null', '');
                    if (commands[i] == null){
                        commands[i] = [];
                    }
                    commands[i].push(''+comm+''+innerCommand[1]);
                }

            */
            }

            window.full = true;
            updateList();
        });
        fileReader.readAsText(file);

    }

    function singleBox(){
        d3.selectAll('#multiBox').style('display', 'none');
        commands = [];
        numBots = null;
        document.getElementById('loadcommands').value = '';
        d3.selectAll('.autocomplete').remove();
        d3.selectAll('#singleBox').style('display', 'inline');
        //updateListSingle();

    }

    function multiBox() {
        d3.selectAll('#singleBox').style('display', 'none');
        commands = [];
        numBots = null;
        d3.selectAll('.autocomplete').remove();
        d3.selectAll('#multiBox').style('display', 'inline');
    }




    </script>

    <div style="margin: 1%">
        <form action='javascript:void(0)'>
            <p>
                Choose how the robots will communicate:
            </p>
            <input list='commTypes' id='communicate'/>
            <datalist id='commTypes'>
                <option>Wireless</option>
                <option>Face to Face</option>
            </datalist>
            <input type='submit' value='Assign to all...' onClick='singleBox()' />
            <input type='submit' value='Assign separately...' onClick='multiBox()' />
        </form>
    </div>
    <div style='display:none; margin: 1%;' id='multiBox'>
        <form class= 'multiBox' action='javascript:void(0)'> <!-- this keeps the page from reloading-->
            <input type='number' min=1 max=30 id='numBotsMulti'/>
            <input type='submit' value='Input the number of Bots to use...' onClick='updateList()'/>
            <input type='submit' class='copypaste' value='Save Commands' onClick='saveCommands()' />
            <input type='file' class='copypaste' id='loadcommands' value='Load Commands' accept='.icl' onchange='loadCommands(event)' />
        </form>
    </div>
    <div style='display:none; margin: 1%;' id='singleBox'>
        <form class='singleBox'  action='javascript:void(0)'>
            <input type='number' min=1 max=30 id='numBotsSingle' />
            <input type='submit' value='Input the number of Bots to use...' onClick='updateListSingle()' />
            <input type='submit' class='copypaste' value='Save Commands' onClick='saveCommands()' />
        </form>
    </div>
</body>
</html>
