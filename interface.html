<!doctype html>
<html>
<head>
    <script src='https://d3js.org/d3.v5.min.js'></script>
    <script src='https://fastcdn.org/FileSaver.js/1.1.20151003/FileSaver.js'></script>
</head>

<body>
    <style>

            * { box-sizing: border-box; }
        body {
          font: 16px Arial;
        }
        .autocomplete {
          /*the container must be positioned relative:*/
          position: relative;
          display: inline-block;
        }
        input {
          border: 1px solid transparent;
          background-color: #f1f1f1;
          padding: 10px;
          font-size: 16px;
        }
        input[type=text] {
          background-color: #f1f1f1;
        }
        input[type=submit] {
          background-color: DodgerBlue;
          color: #fff;
        }
        button {
            background-color: DodgerBlue;
            color: #fff;
        }

        input.reset {
            background-color: Red;
            color: #fff;
        }

        input.copypaste {
            background-color: #ccc;
            color: #000;
        }

        .autocomplete-items {
          position: relative;
          border: 1px solid #d4d4d4;
          border-bottom: none;
          border-top: none;
          z-index: 99;
          /*position the autocomplete items to be the same width as the container:*/
          top: 100%;
          left: 0;
          right: 0;
        }
        .autocomplete-items div {
          padding: 10px;
          cursor: pointer;
          background-color: #fff;
          border-bottom: 1px solid #d4d4d4;
        }
        .autocomplete-items div:hover {
          /*when hovering an item:*/
          background-color: #e9e9e9;
        }
        .autocomplete-active {
          /*when navigating through the items using the arrow keys:*/
          background-color: DodgerBlue !important;
          color: #ffffff;
        }
    </style>
    <script>

    /*

    Interface t03 (previous t02) is version 2.0 of interface_alt.

    The goal of this is to allow the user to essentially program the robots using pseudocode.
    The commands are attempted to autocomplete as the user types, so that there is no confusion
    as to what the list of commands is or what they can be.
    There are convenient copy/paste options because most of the time, the robots will be following similar
    algorithms, with only a slight change in values passed to them. The propsed design choice is to
    show default commands with an X in place of a value, and set that value to be
    random (when based on angles) or indefinitely/until a signal is recieved (when based on time).
    For now, input via the main textbox, paste button, and editing a line is permitted.


    TODO: show all commands when the focus is on an empty textbox. (edit autocomplete)
    TODO: delete and insert specific lines in the command list.
    TODO; create reader and text file with commands in it


    Fixed: t02 --> t03
    - Bug where copy array would be a direct reference to commands subarray, now it is just a naive clone.
        - Consequence of this is that the commands in the box that were copied can be removed, and the
        copy clone will still work.
    - Can now edit a command by the line and the changes will be saved.
    - Remove unecessary function definitions.
    - Added the save commands feature, which saves an ICL file.
    - Add framework for loading of commands.
    - Fixed a bug which did not allow the line to be edited when an empty string was sent to the commands.


    */

    var winH = window.innerHeight;
    var winW = window.innerWidth;
    var unit2px = ((winH < winW) ? (winH) : (winW))/8; //one unit is 1/8th of the smaller portion screen
    var eventListener;
    var numBots;
    var commands = [];
    const commandsList = ['GoOutAtAngle X', 'Wait', 'FollowWall', 'WaitFor X',
                          'FollowWallFor X', 'GoToCenter', 'WaitAverage', 'GoToExit'];

    const comparator = ['GoOutAtAngle','Wait','FollowWall','WaitFor',
                        'FollowWallFor','GoToCenter','WaitAverage','GoToExit'];

    var copy = [];

    var titleArea = d3.select('body').append('svg')
        .attr('width', winW)
        .attr('height', unit2px)
        .attr('class', 'title');
    var title = titleArea.append('text')
        .text('TITLE')
        .attr('text-anchor', 'middle')
        .attr('x', winW/2)
        .attr('y', unit2px/2)
        .attr('font-size', '48px')
        .attr('class', 'title');
    d3.select('body').append('p')
        .text('Replace "X" in a command suggestion with a number to specify a value!');

    function updateList(){
        var numBots = document.getElementById('numBots').value;
        if (numBots > 100) {
            alert("Slow down there partner, don't wanna crash the site... Try a number in range.")
            return;
        }
        if (numBots < 1) {
            alert("You need at least 1 robot!");
            return;
        }
        d3.selectAll('.autocomplete').remove();
        commands = [];

        for (i=0; i<numBots;i++) {
            commands.push([]);
            var d = d3.select('body').append('div')
                .style('width', unit2px*3+'px')
                .style('height', unit2px*3+'px')
                .attr('float', 'left')
                .style('position', 'relative')
                .style('overflow-y', 'scroll')
                .attr('class', 'autocomplete')
                .style('border', '1px black solid')
                .style('border-radius', '5px')
                .style('margin', '0.5%');
            form = d.append('form')
                .attr('id', 'formno'+i)
                .attr('action', 'javascript:void(0)')
                .attr('autocomplete', 'off');
            list = d.append('ol');
            var b = form.append('input')
                .attr('type', 'text')
                .attr('id', 'inputno'+i) // !important!, how we differentiate between different form inputs.
                .on('keydown', function() {
                    if (event.keyCode == 13) {this.form.submit(); return false;}
                });

            form.append('input')
                .attr('type', 'submit')
                .property('value','Enter')
                .on('click', function() {
                    console.log(d3.select(this.parentNode.parentNode).select('ol').node().getElementsByTagName('li')); //
                    var id = d3.select(this.parentNode).attr('id').substring(6);
                    var v = d3.select(this.parentNode).select('input').property('value');
                    if (v == '') {
                        v = '__________';
                    }
                    d3.select(this.parentNode).select('input').property('value',''); //reset textbox because why not.
                    commands[id].push(v);
                    var idno = d3.select(this.parentNode.parentNode).select('ol').node().getElementsByTagName('li').length;
                    var li = d3.select(this.parentNode.parentNode).select('ol').append('li').attr('id', 'listid'+idno);
                    li.append('span')
                        .text(v)
                        .attr('class', 'display')
                        .on('click' , function(d) {
                            console.log(d3.select(this.parentNode).node());
                            var edit = d3.select(this).text();
                            d3.select(this).style('display', 'none');
                            d3.select(this.parentNode).select('.edit').style('display', 'inline').property('value', edit);
                        })
                    li.append('input')
                        .attr('class', 'edit')
                        .style('display', 'none')
                        .on('focusout', function(){
                            var idindex = +d3.select(this.parentNode).attr('id').substring(6);
                            var edit = d3.select(this).property('value');
                            if (edit == ''){
                                edit = '__________';
                            }
                            d3.select(this).style('display', 'none');
                            d3.select(this.parentNode).select('.display').style('display', 'inline').text(edit);
                            commands[id][idindex] = edit;
                        });
                }); //ENTER BUTTON

            form.append('input')
                .attr('type', 'submit')
                .property('value','X')
                .attr('class', 'reset')
                .on('click', function(){
                    var id = d3.select(this.parentNode).attr('id').substring(6);
                    commands[id] = [];
                    console.log(commands);
                    var divTemp = d3.select(this.parentNode.parentNode);
                    divTemp.select('ol').remove();
                    divTemp.append('ol');
                }); //X BUTTON

            form.append('input')
                .attr('type', 'submit')
                .attr('class', 'copypaste')
                .property('value', 'Copy')
                .on('click', function() {
                    var id = d3.select(this.parentNode).attr('id').substring(6);
                    console.log(id);
                    copy = commands[id].slice(0);
                    console.log(commands[id]);
                }); //COPY BUTTON

            form.append('input') //PASTE BUTTON
                .attr('type', 'submit')
                .attr('class', 'copypaste')
                .property('value', 'Paste')
                .on('click', function() {
                    var id = d3.select(this.parentNode).attr('id').substring(6);
                    console.log(id);
                    divTemp = d3.select(this.parentNode.parentNode);
                    divTemp.select('ol').remove();
                    divTemp.append('ol');
                    for (x=0;x<copy.length;x++) {
                        var li = divTemp.select('ol').append('li').attr('id', 'listid'+x);
                        li.append('span')
                            .text(copy[x])
                            .attr('class', 'display')
                            .on('click' , function(d) {
                                var edit = d3.select(this).text();
                                d3.select(this).style('display', 'none');
                                d3.select(this.parentNode).select('.edit').style('display', 'inline').property('value', edit);
                            })
                        li.append('input')
                            .attr('class', 'edit')
                            .style('display', 'none')
                            .on('focusout', function(){
                                var idindex = +d3.select(this.parentNode).attr('id').substring(6);
                                var edit = d3.select(this).property('value');
                                if (edit == ''){
                                    edit = '__________';
                                }
                                d3.select(this).style('display', 'none');
                                d3.select(this.parentNode).select('.display').style('display', 'inline').text(edit);
                                commands[id][idindex] = edit;
                            });
                    }
                    commands[id] = copy.slice(0);
                });

            //add all event listeners to inputs
            autocomplete(b.node(), commandsList);

        }
    }

    function autocomplete(inp, arr) {
      // https://www.w3schools.com/howto/howto_js_autocomplete.asp //
      var currentFocus;
      inp.addEventListener("input", function(e) {
          var a, b, i, val = this.value;
          closeAllLists();
          if (!val) { return false;}
          currentFocus = -1;
          a = document.createElement("DIV");
          a.setAttribute("id", this.id + "autocomplete-list");
          a.setAttribute("class", "autocomplete-items");
          this.parentNode.appendChild(a);
          for (i = 0; i < arr.length; i++) {
            if (arr[i].substr(0, val.length).toUpperCase() == val.toUpperCase()) {
              b = document.createElement("DIV");
              b.innerHTML = "<strong>" + arr[i].substr(0, val.length) + "</strong>";
              b.innerHTML += arr[i].substr(val.length);
              b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
                  b.addEventListener("click", function(e) {
                  inp.value = this.getElementsByTagName("input")[0].value;
                  closeAllLists();
              });
              a.appendChild(b);
            }
          }
      });
      inp.addEventListener("keydown", function(e) {
          var x = document.getElementById(this.id + "autocomplete-list");
          if (x) x = x.getElementsByTagName("div");
          if (e.keyCode == 40) {
            currentFocus++;
            addActive(x);
          } else if (e.keyCode == 38) { //up
            currentFocus--;
            addActive(x);
          } else if (e.keyCode == 13) {
            e.preventDefault();
            if (currentFocus > -1) {
              if (x) x[currentFocus].click();
            }
          }
      });
      function addActive(x) {
        if (!x) return false;
        removeActive(x);
        if (currentFocus >= x.length) currentFocus = 0;
        if (currentFocus < 0) currentFocus = (x.length - 1);
        x[currentFocus].classList.add("autocomplete-active");
      }
      function removeActive(x) {
        for (var i = 0; i < x.length; i++) {
          x[i].classList.remove("autocomplete-active");
        }
      }
      function closeAllLists(elmnt) {
        var x = document.getElementsByClassName("autocomplete-items");
        for (var i = 0; i < x.length; i++) {
          if (elmnt != x[i] && elmnt != inp) {
          x[i].parentNode.removeChild(x[i]);
          }
        }
      }
      document.addEventListener("click", function (e) {
        closeAllLists(e.target);
      });
    }

    function saveCommands() {
        console.log(commands);
        console.log(comparator);

        var l = commands.length;
        var s = '';
        for (i=0;i<l;i++) {
            for (j=0;j<commands[i].length;j++) {
                for (c=comparator.length;c>=0;c--) {
                    if (commands[i][j].includes(comparator[c])){
                        s+='['+c+':'
                        var args = commands[i][j].substring(comparator[c].length);
                        if (args.length == 0) {
                            args = ' null]';
                        }
                        else {
                            args += ']';
                        }
                        s+=args;
                        console.log(s);
                        break;
                    }
                }
            }
            s += '\n';
        }
        var blob = new Blob([s], {type: 'text/plain;charset=utf-8'});
        saveAs(blob, 'my-algorithm.icl');
    }

    function loadCommands() {
        console.log('loading...');
    }


    </script>

    <form style="margin:3%" action="javascript:void(0)"> <!-- this keeps the page from reloading-->
        <input type='number' min=1 max=30 name='bots' id='numBots'/>
        <input type='submit' value='Input the number of Bots to use...' onClick="updateList()"/>
    </form>
    <form style="margin:3% ; position: relative;" action="javascript:void(0)">
        <input type='submit' class='copypaste' value='Save Commands' onClick='saveCommands()' />
        <input type='submit' class='copypaste' value='Load Commands' onClick='loadCommands()' />
    </form>
</body>
</html>
