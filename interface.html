<!doctype html>
<html>

<head>
    <script src="https://d3js.org/d3.v5.min.js"></script>
</head>

<body>
    <style>
    .center {
        margin: auto;
        width: 50%;
        height: 25%;
    }

    </style>
    <script>

    //---Name Classes---//

    class CommandBlock {
        constructor (x, y, type, commandFn, params, prevNode, nextNode){
            this.x = x;
            this.y = y;
            this.height = (window.innerHeight*1.5)/10;
            this.width = (window.innerWidth*1.5)/10;
            this.commandFn = commandFn;
            this.params = [];
            this.type = type;
            this.prevNode = null;
            this.nextNode = null;
            this.draw(this);
        }

        draw(commandBlock) {
            //commandBlock takes itself in draw because when the SVG is selected, it becomes 'this'
            //so we have to sepcify that we want the commandBlock's attributes to change, unfortunately.
            var box = d3.select('.binder').append('svg')
            .attr('x', this.x)
            .attr('y', this.y)
            .attr('width', this.width)
            .attr('height', this.height)
            .call(d3.drag().on('start', activateBox)
                           .on('drag', updateBox)
                           .on("end", deactivateBox));

            box.append('rect') //the block itself
                .attr('x', 0)
                .attr('y', 0)
                .attr('width', this.width)
                .attr('height', this.height)
                .attr('stroke', 'black')
                .attr('stroke-width', 3)
                .attr('fill', '#ddd')
                .attr('class', 'block');

            var fo = box.append('foreignObject')
                .attr('x', this.width/3)
                .attr('y', 10)
                .attr('width', 50);

            var textBox = fo.append('xhtml:div').append('div').append('input')
                .attr('name', 'Angle')
                .attr('type', 'number')
                .attr('min', 0)
                .attr('max', 360)
                .attr('value', 0)
                .attr('class', 'textbox')
                .on('mouseDown', deactivateBox); // so the box doesnt move when the textbox arrows are held...

            box.append('rect') // the button
                .attr('x', this.width/3)
                .attr('y', this.height/3)
                .attr('width', '30%')
                .attr('height', '20%')
                .attr('stroke', 'black')
                .attr('fill', '#68ff63')
                .on('click', function () {
                    commandBlock.params = +d3.select(this.parentNode).select('.textbox').property('value'); //selects parent svg of the button, then goes back into the children to find the textbox input
                    console.log(commandBlock.params);
                    d3.select(this.parentNode).select('.infotext').remove();
                    var label = d3.select(this.parentNode).append('text')
                        .text('Go at angle: ' + commandBlock.params)
                        .style('font-size', '26px')
                        .style('fill', 'black')
                        .attr("transform", "translate(20, 100) rotate(0)")
                        .attr('text-anchor', 'left')
                        .attr('class', 'infotext');
                });
        }

        callCommand(commandBlock) {
            return function () { //closure scope, only calls function when button is clicked
                commandBlock.commandFn(commandBlock.params);
            }
        }

    }


    //---Instantiate Variables---//
    var winWidth = window.innerWidth;
    var winHeight = window.innerHeight;
    var emptyQueue = [];
    var commandQueue = [];
    console.log(winWidth);
    console.log(winHeight);

    var win = d3.select('body').append('svg')
              .attr('width', winWidth)
              .attr('height', winHeight)
              .attr('class', 'binder');


    //---Name Functions---//

    function distance(x1, y1, x2, y2) {
        return Math.sqrt(((x2 - x1)*(x2-x1)) + ((y2-y1)*(y2-y1)));
    }

    function createBlank(svg, x, y) {

        var blank = svg.append('rect')
           .attr('width', '10%')
           .attr('height', '10%')
           .attr('x', x)
           .attr('y', y)
           .style('stroke', '#999')
           .style('fill', '#ddd')
           .style('stroke-width', 3)
           .style('stroke-dasharray', '10 7')
        emptyQueue.push([x, y]);
    }

    function activateBox() {
        d3.select(this).attr('stroke', 'gray').attr('fill', '#ccc').attr('class', 'commandBox');
        d3.select(this).classed('active', true);



    }

    function updateBox() {
        var mousePosX = d3.event.x;
        var mousePosY = d3.event.y;
        var newCommand = false;

        d3.select(this).attr('x', mousePosX).attr('y', mousePosY);

        //console.log(emptyQueue);

        for (r=0; r<emptyQueue.length; r++) {
            var x1 = +emptyQueue[r][0];
            var y1 = +emptyQueue[r][1];
            if (distance(x1, y1, mousePosX, mousePosY) < 25) {
                d3.select(this).attr('x', x1).attr('y', y1);

            }
        }

    }

    function deactivateBox() {
        d3.select(this).attr('stroke', 'black').attr('fill', '#ddd');
        d3.select(this).classed('active', false);
    }

    //---Set up boundaries---//
    win.append('line')
        .attr('x1', winWidth * 0.6)
        .attr('y1', 0)
        .attr('x2', winWidth * 0.6)
        .attr('y2', winHeight)
        .style('stroke', '#000')
        .attr('stroke-width', 3);

    var goBox = win.append('rect')
        .attr('x', winWidth * 0.7)
        .attr('y', winHeight/15)
        .attr('width', '10%')
        .attr('height', '10%')
        .style('stroke', 'black')
        .attr('stroke-width', 3)
        .attr('fill', '#ddd')
        .call(d3.drag().on('start', function() { new CommandBlock(d3.event.x, d3.event.y, null, null, null, null, null); }));

    var testCommand = new CommandBlock(100, 100, 'goAtAngle', testCommands, [], null, null);
    //var test2 = new CommandBlock(100, 300, 'goAtAngle', testCommands, [], null, null);
    console.log(testCommand.params);

    function testCommands(parameter) {
        console.log('the command block passed me a parameter');
        console.log(parameter);
    }

    var start = win.append('svg')
        .attr('x', winWidth * 0.7)
        .attr('y', winHeight * 0.7)
        .attr('width', '10%')
        .attr('height', '10%')
    .append('rect')
        .attr('x', 0)
        .attr('y', 0)
        .attr('width', '100%')
        .attr('height', '100%')
        .attr('stroke', 'green')
        .attr('fill', '#a3ffa0')
        .on('click', testCommand.callCommand(testCommand));



        //.on('click', function() {d3.select(this).attr('stroke', '#333').attr('fill', '#fff');});


    //var form = d3.select(goBox).append('form');
    //var label = de.select(goBox).append('label');

    //form.enter().append('input').attr('type', 'text').attr('name', 'Angle');


    </script>

    <g>
        <button name="test button" type="submit" value="submit-true"></button>

    </g>
</body>

</html>
